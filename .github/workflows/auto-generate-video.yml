name: Auto Generate Video

on:
  issues:
    types: [labeled]

env:
  CLAUDE_FLOW_VERSION: 'alpha'
  NODE_VERSION: '20'

jobs:
  generate-video:
    if: github.event.label.name == 'video-request'
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Cache Claude Flow
        uses: actions/cache@v4
        with:
          path: |
            ~/.npm/_npx
            /usr/local/lib/node_modules/claude-flow
          key: claude-flow-${{ env.CLAUDE_FLOW_VERSION }}-${{ runner.os }}
          restore-keys: |
            claude-flow-${{ env.CLAUDE_FLOW_VERSION }}-

      - name: Install Claude Flow
        run: npm install -g claude-flow@${{ env.CLAUDE_FLOW_VERSION }}

      - name: Cache npm dependencies
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: npm-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            npm-

      - name: Install dependencies
        run: npm ci

      - name: Install Chromium dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libnss3 \
            libatk1.0-0 \
            libatk-bridge2.0-0 \
            libcups2 \
            libdrm2 \
            libxkbcommon0 \
            libxcomposite1 \
            libxdamage1 \
            libxfixes3 \
            libxrandr2 \
            libgbm1 \
            libasound2

      - name: Parse Issue and Generate Script
        id: parse-issue
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          ISSUE_BODY: ${{ github.event.issue.body }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
        run: |
          # Claude Flow Swarmã§å°æœ¬ã‚’ç”Ÿæˆ
          npx claude-flow@${{ env.CLAUDE_FLOW_VERSION }} swarm \
            "ä»¥ä¸‹ã®Issueã‹ã‚‰å‹•ç”»ç”¨ã®å°æœ¬JSONã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚
            
            ã‚¿ã‚¤ãƒˆãƒ«: $ISSUE_TITLE
            
            å†…å®¹:
            $ISSUE_BODY
            
            å‡ºåŠ›å½¢å¼ã¯ scripts/schema.json ã«å¾“ã£ã¦ãã ã•ã„ã€‚
            çµæœã¯ scripts/input/generated.json ã«ä¿å­˜ã—ã¦ãã ã•ã„ã€‚" \
            --non-interactive \
            --output-format json

      - name: Render Video
        run: |
          # ç”Ÿæˆã•ã‚ŒãŸå°æœ¬ã‚’ä½¿ç”¨ã—ã¦ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
          SCRIPT_FILE="scripts/input/generated.json"
          
          if [ -f "$SCRIPT_FILE" ]; then
            npx remotion render src/index.ts Main output/video.mp4 \
              --props="$(cat $SCRIPT_FILE)" \
              --codec=h264 \
              --quality=80 \
              --log-level=info
          else
            echo "Script file not found, using default"
            npx remotion render src/index.ts Main output/video.mp4 \
              --codec=h264 \
              --quality=80
          fi

      - name: Upload Video Artifact
        uses: actions/upload-artifact@v4
        with:
          name: generated-video-${{ github.event.issue.number }}
          path: output/video.mp4
          retention-days: 7

      - name: Comment on Issue
        uses: actions/github-script@v7
        with:
          script: |
            const artifactUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `## ğŸ¬ å‹•ç”»ç”Ÿæˆå®Œäº†ï¼
              
              å‹•ç”»ãŒæ­£å¸¸ã«ç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚
              
              **ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æ–¹æ³•:**
              1. [GitHub Actions Run](${artifactUrl}) ã«ã‚¢ã‚¯ã‚»ã‚¹
              2. ã€ŒArtifactsã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‹ã‚‰ \`generated-video-${context.issue.number}\` ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
              
              **æ³¨æ„:** Artifactã¯7æ—¥é–“ä¿æŒã•ã‚Œã¾ã™ã€‚
              
              ---
              *Generated by Video Flow Template*`
            });

      - name: Remove label on success
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.removeLabel({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              name: 'video-request'
            });
            
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ['video-completed']
            });
